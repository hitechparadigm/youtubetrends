"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.VideoRepository = void 0;
const base_repository_1 = require("./base-repository");
const video_metadata_1 = require("../models/video-metadata");
class VideoRepository extends base_repository_1.BaseRepository {
    constructor(config = {}) {
        super(process.env.VIDEO_METADATA_TABLE_NAME || 'VideoMetadata', config);
    }
    async saveVideo(video) {
        const item = video_metadata_1.VideoMetadataModel.toDynamoDbItem(video);
        await this.put({
            Item: item,
            ConditionExpression: 'attribute_not_exists(videoId)'
        });
    }
    async getVideo(videoId) {
        const item = await this.get({
            Key: { videoId }
        });
        return item ? video_metadata_1.VideoMetadataModel.fromDynamoDbItem(item) : null;
    }
    async updateVideo(video) {
        const item = video_metadata_1.VideoMetadataModel.toDynamoDbItem(video);
        const updatedItem = await this.update({
            Key: { videoId: video.videoId },
            UpdateExpression: `
        SET title = :title,
            description = :description,
            tags = :tags,
            categoryId = :categoryId,
            privacyStatus = :privacyStatus,
            viewCount = :viewCount,
            likeCount = :likeCount,
            commentCount = :commentCount,
            revenue = :revenue,
            sourceTrends = :sourceTrends,
            generationCost = :generationCost,
            processingCost = :processingCost,
            s3Key = :s3Key,
            bedrockJobId = :bedrockJobId,
            mediaConvertJobId = :mediaConvertJobId,
            #status = :status,
            performanceMetrics = :performanceMetrics,
            updatedAt = :updatedAt
      `,
            ExpressionAttributeNames: {
                '#status': 'status'
            },
            ExpressionAttributeValues: {
                ':title': item.title,
                ':description': item.description,
                ':tags': item.tags,
                ':categoryId': item.categoryId,
                ':privacyStatus': item.privacyStatus,
                ':viewCount': item.viewCount,
                ':likeCount': item.likeCount,
                ':commentCount': item.commentCount,
                ':revenue': item.revenue,
                ':sourceTrends': item.sourceTrends,
                ':generationCost': item.generationCost,
                ':processingCost': item.processingCost,
                ':s3Key': item.s3Key,
                ':bedrockJobId': item.bedrockJobId,
                ':mediaConvertJobId': item.mediaConvertJobId,
                ':status': item.status,
                ':performanceMetrics': item.performanceMetrics,
                ':updatedAt': item.updatedAt
            },
            ReturnValues: 'ALL_NEW'
        });
        return video_metadata_1.VideoMetadataModel.fromDynamoDbItem(updatedItem);
    }
    async updateVideoStatus(videoId, status) {
        const updatedItem = await this.update({
            Key: { videoId },
            UpdateExpression: 'SET #status = :status, updatedAt = :updatedAt',
            ExpressionAttributeNames: {
                '#status': 'status'
            },
            ExpressionAttributeValues: {
                ':status': status,
                ':updatedAt': new Date().toISOString()
            },
            ReturnValues: 'ALL_NEW'
        });
        return video_metadata_1.VideoMetadataModel.fromDynamoDbItem(updatedItem);
    }
    async updateYouTubeData(videoId, youtubeId, viewCount = 0, likeCount = 0, commentCount = 0) {
        const updatedItem = await this.update({
            Key: { videoId },
            UpdateExpression: `
        SET youtubeId = :youtubeId,
            viewCount = :viewCount,
            likeCount = :likeCount,
            commentCount = :commentCount,
            #status = :status,
            updatedAt = :updatedAt
      `,
            ExpressionAttributeNames: {
                '#status': 'status'
            },
            ExpressionAttributeValues: {
                ':youtubeId': youtubeId,
                ':viewCount': viewCount,
                ':likeCount': likeCount,
                ':commentCount': commentCount,
                ':status': video_metadata_1.VideoStatus.PUBLISHED,
                ':updatedAt': new Date().toISOString()
            },
            ReturnValues: 'ALL_NEW'
        });
        return video_metadata_1.VideoMetadataModel.fromDynamoDbItem(updatedItem);
    }
    async updatePerformanceMetrics(videoId, metrics) {
        const existingVideo = await this.getVideo(videoId);
        if (!existingVideo) {
            throw new Error(`Video with ID ${videoId} not found`);
        }
        const updatedMetrics = {
            ...existingVideo.performanceMetrics,
            ...metrics
        };
        const updatedItem = await this.update({
            Key: { videoId },
            UpdateExpression: 'SET performanceMetrics = :metrics, updatedAt = :updatedAt',
            ExpressionAttributeValues: {
                ':metrics': updatedMetrics,
                ':updatedAt': new Date().toISOString()
            },
            ReturnValues: 'ALL_NEW'
        });
        return video_metadata_1.VideoMetadataModel.fromDynamoDbItem(updatedItem);
    }
    async getVideosByStatus(status, limit = 50) {
        const items = await this.scan({
            FilterExpression: '#status = :status',
            ExpressionAttributeNames: {
                '#status': 'status'
            },
            ExpressionAttributeValues: {
                ':status': status
            },
            Limit: limit
        });
        return items.map(item => video_metadata_1.VideoMetadataModel.fromDynamoDbItem(item));
    }
    async getVideosByDateRange(startDate, endDate, options = {}) {
        let filterExpression = 'uploadDate BETWEEN :startDate AND :endDate';
        const expressionAttributeValues = {
            ':startDate': startDate,
            ':endDate': endDate
        };
        if (options.status) {
            filterExpression += ' AND #status = :status';
            expressionAttributeValues[':status'] = options.status;
        }
        // Use scan instead of query since we need to filter by date range
        // and the GSI only has uploadDate as partition key
        const items = await this.scan({
            FilterExpression: filterExpression,
            ExpressionAttributeNames: options.status ? { '#status': 'status' } : undefined,
            ExpressionAttributeValues: expressionAttributeValues,
            Limit: options.limit
        });
        // Sort by upload date descending (most recent first)
        const sortedItems = items.sort((a, b) => new Date(b.uploadDate).getTime() - new Date(a.uploadDate).getTime());
        return sortedItems.map(item => video_metadata_1.VideoMetadataModel.fromDynamoDbItem(item));
    }
    async getRecentVideos(days = 7, limit = 50) {
        const startDate = new Date(Date.now() - days * 24 * 60 * 60 * 1000)
            .toISOString()
            .split('T')[0];
        const endDate = new Date().toISOString().split('T')[0];
        return this.getVideosByDateRange(startDate, endDate, { limit });
    }
    async getTopPerformingVideos(days = 30, limit = 10) {
        const startDate = new Date(Date.now() - days * 24 * 60 * 60 * 1000)
            .toISOString()
            .split('T')[0];
        const endDate = new Date().toISOString().split('T')[0];
        const videos = await this.getVideosByDateRange(startDate, endDate);
        return videos
            .filter(video => video.status === video_metadata_1.VideoStatus.PUBLISHED)
            .sort((a, b) => {
            // Sort by engagement rate, then by view count
            const aEngagement = (a.likeCount + a.commentCount) / Math.max(a.viewCount, 1);
            const bEngagement = (b.likeCount + b.commentCount) / Math.max(b.viewCount, 1);
            if (aEngagement !== bEngagement) {
                return bEngagement - aEngagement;
            }
            return b.viewCount - a.viewCount;
        })
            .slice(0, limit);
    }
    async getVideoAnalytics(days = 30) {
        const startDate = new Date(Date.now() - days * 24 * 60 * 60 * 1000)
            .toISOString()
            .split('T')[0];
        const endDate = new Date().toISOString().split('T')[0];
        const videos = await this.getVideosByDateRange(startDate, endDate);
        const statusBreakdown = Object.values(video_metadata_1.VideoStatus).reduce((acc, status) => {
            acc[status] = 0;
            return acc;
        }, {});
        let totalViews = 0;
        let totalRevenue = 0;
        let totalCosts = 0;
        let totalROI = 0;
        let publishedVideos = 0;
        videos.forEach(video => {
            statusBreakdown[video.status]++;
            if (video.status === video_metadata_1.VideoStatus.PUBLISHED) {
                publishedVideos++;
                totalViews += video.viewCount;
                totalRevenue += video.revenue;
            }
            totalCosts += video.generationCost + video.processingCost;
            totalROI += video_metadata_1.VideoMetadataModel.calculateROI(video);
        });
        return {
            totalVideos: videos.length,
            publishedVideos,
            totalViews,
            totalRevenue,
            averageROI: videos.length > 0 ? totalROI / videos.length : 0,
            totalCosts,
            statusBreakdown
        };
    }
    async deleteVideo(videoId) {
        await this.delete({
            Key: { videoId }
        });
    }
    async getVideosBySourceTrend(trendTopic, limit = 20) {
        const items = await this.scan({
            FilterExpression: 'contains(sourceTrends, :trendTopic)',
            ExpressionAttributeValues: {
                ':trendTopic': trendTopic
            },
            Limit: limit
        });
        return items.map(item => video_metadata_1.VideoMetadataModel.fromDynamoDbItem(item));
    }
    async updateCosts(videoId, generationCost, processingCost) {
        const updateExpressions = [];
        const expressionAttributeValues = {
            ':updatedAt': new Date().toISOString()
        };
        if (generationCost !== undefined) {
            updateExpressions.push('generationCost = :generationCost');
            expressionAttributeValues[':generationCost'] = generationCost;
        }
        if (processingCost !== undefined) {
            updateExpressions.push('processingCost = :processingCost');
            expressionAttributeValues[':processingCost'] = processingCost;
        }
        updateExpressions.push('updatedAt = :updatedAt');
        const updatedItem = await this.update({
            Key: { videoId },
            UpdateExpression: `SET ${updateExpressions.join(', ')}`,
            ExpressionAttributeValues: expressionAttributeValues,
            ReturnValues: 'ALL_NEW'
        });
        return video_metadata_1.VideoMetadataModel.fromDynamoDbItem(updatedItem);
    }
}
exports.VideoRepository = VideoRepository;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidmlkZW8tcmVwb3NpdG9yeS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInZpZGVvLXJlcG9zaXRvcnkudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsdURBQXFFO0FBQ3JFLDZEQUE4RztBQVM5RyxNQUFhLGVBQWdCLFNBQVEsZ0NBQWM7SUFDakQsWUFBWSxTQUEyQixFQUFFO1FBQ3ZDLEtBQUssQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLHlCQUF5QixJQUFJLGVBQWUsRUFBRSxNQUFNLENBQUMsQ0FBQztJQUMxRSxDQUFDO0lBRUQsS0FBSyxDQUFDLFNBQVMsQ0FBQyxLQUFvQjtRQUNsQyxNQUFNLElBQUksR0FBRyxtQ0FBa0IsQ0FBQyxjQUFjLENBQUMsS0FBSyxDQUFDLENBQUM7UUFFdEQsTUFBTSxJQUFJLENBQUMsR0FBRyxDQUFDO1lBQ2IsSUFBSSxFQUFFLElBQUk7WUFDVixtQkFBbUIsRUFBRSwrQkFBK0I7U0FDckQsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVELEtBQUssQ0FBQyxRQUFRLENBQUMsT0FBZTtRQUM1QixNQUFNLElBQUksR0FBRyxNQUFNLElBQUksQ0FBQyxHQUFHLENBQUM7WUFDMUIsR0FBRyxFQUFFLEVBQUUsT0FBTyxFQUFFO1NBQ2pCLENBQUMsQ0FBQztRQUVILE9BQU8sSUFBSSxDQUFDLENBQUMsQ0FBQyxtQ0FBa0IsQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDO0lBQ2pFLENBQUM7SUFFRCxLQUFLLENBQUMsV0FBVyxDQUFDLEtBQW9CO1FBQ3BDLE1BQU0sSUFBSSxHQUFHLG1DQUFrQixDQUFDLGNBQWMsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUV0RCxNQUFNLFdBQVcsR0FBRyxNQUFNLElBQUksQ0FBQyxNQUFNLENBQUM7WUFDcEMsR0FBRyxFQUFFLEVBQUUsT0FBTyxFQUFFLEtBQUssQ0FBQyxPQUFPLEVBQUU7WUFDL0IsZ0JBQWdCLEVBQUU7Ozs7Ozs7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O1lBQ3BELFlBQVksRUFBRSxTQUFTO1NBQ3hCLENBQUMsQ0FBQztRQUVILE9BQU8sbUNBQWtCLENBQUMsZ0JBQWdCLENBQUMsV0FBVyxDQUFDLENBQUM7SUFDMUQsQ0FBQztDQUNGO0FBbFZELDBDQWtWQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEJhc2VSZXBvc2l0b3J5LCBSZXBvc2l0b3J5Q29uZmlnIH0gZnJvbSAnLi9iYXNlLXJlcG9zaXRvcnknO1xyXG5pbXBvcnQgeyBWaWRlb01ldGFkYXRhLCBWaWRlb01ldGFkYXRhTW9kZWwsIFZpZGVvU3RhdHVzLCBQZXJmb3JtYW5jZU1ldHJpY3MgfSBmcm9tICcuLi9tb2RlbHMvdmlkZW8tbWV0YWRhdGEnO1xyXG5cclxuZXhwb3J0IGludGVyZmFjZSBWaWRlb1F1ZXJ5T3B0aW9ucyB7XHJcbiAgbGltaXQ/OiBudW1iZXI7XHJcbiAgc3RhdHVzPzogVmlkZW9TdGF0dXM7XHJcbiAgc3RhcnREYXRlPzogc3RyaW5nO1xyXG4gIGVuZERhdGU/OiBzdHJpbmc7XHJcbn1cclxuXHJcbmV4cG9ydCBjbGFzcyBWaWRlb1JlcG9zaXRvcnkgZXh0ZW5kcyBCYXNlUmVwb3NpdG9yeSB7XHJcbiAgY29uc3RydWN0b3IoY29uZmlnOiBSZXBvc2l0b3J5Q29uZmlnID0ge30pIHtcclxuICAgIHN1cGVyKHByb2Nlc3MuZW52LlZJREVPX01FVEFEQVRBX1RBQkxFX05BTUUgfHwgJ1ZpZGVvTWV0YWRhdGEnLCBjb25maWcpO1xyXG4gIH1cclxuXHJcbiAgYXN5bmMgc2F2ZVZpZGVvKHZpZGVvOiBWaWRlb01ldGFkYXRhKTogUHJvbWlzZTx2b2lkPiB7XHJcbiAgICBjb25zdCBpdGVtID0gVmlkZW9NZXRhZGF0YU1vZGVsLnRvRHluYW1vRGJJdGVtKHZpZGVvKTtcclxuICAgIFxyXG4gICAgYXdhaXQgdGhpcy5wdXQoe1xyXG4gICAgICBJdGVtOiBpdGVtLFxyXG4gICAgICBDb25kaXRpb25FeHByZXNzaW9uOiAnYXR0cmlidXRlX25vdF9leGlzdHModmlkZW9JZCknXHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIGFzeW5jIGdldFZpZGVvKHZpZGVvSWQ6IHN0cmluZyk6IFByb21pc2U8VmlkZW9NZXRhZGF0YSB8IG51bGw+IHtcclxuICAgIGNvbnN0IGl0ZW0gPSBhd2FpdCB0aGlzLmdldCh7XHJcbiAgICAgIEtleTogeyB2aWRlb0lkIH1cclxuICAgIH0pO1xyXG5cclxuICAgIHJldHVybiBpdGVtID8gVmlkZW9NZXRhZGF0YU1vZGVsLmZyb21EeW5hbW9EYkl0ZW0oaXRlbSkgOiBudWxsO1xyXG4gIH1cclxuXHJcbiAgYXN5bmMgdXBkYXRlVmlkZW8odmlkZW86IFZpZGVvTWV0YWRhdGEpOiBQcm9taXNlPFZpZGVvTWV0YWRhdGE+IHtcclxuICAgIGNvbnN0IGl0ZW0gPSBWaWRlb01ldGFkYXRhTW9kZWwudG9EeW5hbW9EYkl0ZW0odmlkZW8pO1xyXG4gICAgXHJcbiAgICBjb25zdCB1cGRhdGVkSXRlbSA9IGF3YWl0IHRoaXMudXBkYXRlKHtcclxuICAgICAgS2V5OiB7IHZpZGVvSWQ6IHZpZGVvLnZpZGVvSWQgfSxcclxuICAgICAgVXBkYXRlRXhwcmVzc2lvbjogYFxyXG4gICAgICAgIFNFVCB0aXRsZSA9IDp0aXRsZSxcclxuICAgICAgICAgICAgZGVzY3JpcHRpb24gPSA6ZGVzY3JpcHRpb24sXHJcbiAgICAgICAgICAgIHRhZ3MgPSA6dGFncyxcclxuICAgICAgICAgICAgY2F0ZWdvcnlJZCA9IDpjYXRlZ29yeUlkLFxyXG4gICAgICAgICAgICBwcml2YWN5U3RhdHVzID0gOnByaXZhY3lTdGF0dXMsXHJcbiAgICAgICAgICAgIHZpZXdDb3VudCA9IDp2aWV3Q291bnQsXHJcbiAgICAgICAgICAgIGxpa2VDb3VudCA9IDpsaWtlQ291bnQsXHJcbiAgICAgICAgICAgIGNvbW1lbnRDb3VudCA9IDpjb21tZW50Q291bnQsXHJcbiAgICAgICAgICAgIHJldmVudWUgPSA6cmV2ZW51ZSxcclxuICAgICAgICAgICAgc291cmNlVHJlbmRzID0gOnNvdXJjZVRyZW5kcyxcclxuICAgICAgICAgICAgZ2VuZXJhdGlvbkNvc3QgPSA6Z2VuZXJhdGlvbkNvc3QsXHJcbiAgICAgICAgICAgIHByb2Nlc3NpbmdDb3N0ID0gOnByb2Nlc3NpbmdDb3N0LFxyXG4gICAgICAgICAgICBzM0tleSA9IDpzM0tleSxcclxuICAgICAgICAgICAgYmVkcm9ja0pvYklkID0gOmJlZHJvY2tKb2JJZCxcclxuICAgICAgICAgICAgbWVkaWFDb252ZXJ0Sm9iSWQgPSA6bWVkaWFDb252ZXJ0Sm9iSWQsXHJcbiAgICAgICAgICAgICNzdGF0dXMgPSA6c3RhdHVzLFxyXG4gICAgICAgICAgICBwZXJmb3JtYW5jZU1ldHJpY3MgPSA6cGVyZm9ybWFuY2VNZXRyaWNzLFxyXG4gICAgICAgICAgICB1cGRhdGVkQXQgPSA6dXBkYXRlZEF0XHJcbiAgICAgIGAsXHJcbiAgICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVOYW1lczoge1xyXG4gICAgICAgICcjc3RhdHVzJzogJ3N0YXR1cydcclxuICAgICAgfSxcclxuICAgICAgRXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlczoge1xyXG4gICAgICAgICc6dGl0bGUnOiBpdGVtLnRpdGxlLFxyXG4gICAgICAgICc6ZGVzY3JpcHRpb24nOiBpdGVtLmRlc2NyaXB0aW9uLFxyXG4gICAgICAgICc6dGFncyc6IGl0ZW0udGFncyxcclxuICAgICAgICAnOmNhdGVnb3J5SWQnOiBpdGVtLmNhdGVnb3J5SWQsXHJcbiAgICAgICAgJzpwcml2YWN5U3RhdHVzJzogaXRlbS5wcml2YWN5U3RhdHVzLFxyXG4gICAgICAgICc6dmlld0NvdW50JzogaXRlbS52aWV3Q291bnQsXHJcbiAgICAgICAgJzpsaWtlQ291bnQnOiBpdGVtLmxpa2VDb3VudCxcclxuICAgICAgICAnOmNvbW1lbnRDb3VudCc6IGl0ZW0uY29tbWVudENvdW50LFxyXG4gICAgICAgICc6cmV2ZW51ZSc6IGl0ZW0ucmV2ZW51ZSxcclxuICAgICAgICAnOnNvdXJjZVRyZW5kcyc6IGl0ZW0uc291cmNlVHJlbmRzLFxyXG4gICAgICAgICc6Z2VuZXJhdGlvbkNvc3QnOiBpdGVtLmdlbmVyYXRpb25Db3N0LFxyXG4gICAgICAgICc6cHJvY2Vzc2luZ0Nvc3QnOiBpdGVtLnByb2Nlc3NpbmdDb3N0LFxyXG4gICAgICAgICc6czNLZXknOiBpdGVtLnMzS2V5LFxyXG4gICAgICAgICc6YmVkcm9ja0pvYklkJzogaXRlbS5iZWRyb2NrSm9iSWQsXHJcbiAgICAgICAgJzptZWRpYUNvbnZlcnRKb2JJZCc6IGl0ZW0ubWVkaWFDb252ZXJ0Sm9iSWQsXHJcbiAgICAgICAgJzpzdGF0dXMnOiBpdGVtLnN0YXR1cyxcclxuICAgICAgICAnOnBlcmZvcm1hbmNlTWV0cmljcyc6IGl0ZW0ucGVyZm9ybWFuY2VNZXRyaWNzLFxyXG4gICAgICAgICc6dXBkYXRlZEF0JzogaXRlbS51cGRhdGVkQXRcclxuICAgICAgfSxcclxuICAgICAgUmV0dXJuVmFsdWVzOiAnQUxMX05FVydcclxuICAgIH0pO1xyXG5cclxuICAgIHJldHVybiBWaWRlb01ldGFkYXRhTW9kZWwuZnJvbUR5bmFtb0RiSXRlbSh1cGRhdGVkSXRlbSk7XHJcbiAgfVxyXG5cclxuICBhc3luYyB1cGRhdGVWaWRlb1N0YXR1cyh2aWRlb0lkOiBzdHJpbmcsIHN0YXR1czogVmlkZW9TdGF0dXMpOiBQcm9taXNlPFZpZGVvTWV0YWRhdGE+IHtcclxuICAgIGNvbnN0IHVwZGF0ZWRJdGVtID0gYXdhaXQgdGhpcy51cGRhdGUoe1xyXG4gICAgICBLZXk6IHsgdmlkZW9JZCB9LFxyXG4gICAgICBVcGRhdGVFeHByZXNzaW9uOiAnU0VUICNzdGF0dXMgPSA6c3RhdHVzLCB1cGRhdGVkQXQgPSA6dXBkYXRlZEF0JyxcclxuICAgICAgRXhwcmVzc2lvbkF0dHJpYnV0ZU5hbWVzOiB7XHJcbiAgICAgICAgJyNzdGF0dXMnOiAnc3RhdHVzJ1xyXG4gICAgICB9LFxyXG4gICAgICBFeHByZXNzaW9uQXR0cmlidXRlVmFsdWVzOiB7XHJcbiAgICAgICAgJzpzdGF0dXMnOiBzdGF0dXMsXHJcbiAgICAgICAgJzp1cGRhdGVkQXQnOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKClcclxuICAgICAgfSxcclxuICAgICAgUmV0dXJuVmFsdWVzOiAnQUxMX05FVydcclxuICAgIH0pO1xyXG5cclxuICAgIHJldHVybiBWaWRlb01ldGFkYXRhTW9kZWwuZnJvbUR5bmFtb0RiSXRlbSh1cGRhdGVkSXRlbSk7XHJcbiAgfVxyXG5cclxuICBhc3luYyB1cGRhdGVZb3VUdWJlRGF0YShcclxuICAgIHZpZGVvSWQ6IHN0cmluZyxcclxuICAgIHlvdXR1YmVJZDogc3RyaW5nLFxyXG4gICAgdmlld0NvdW50OiBudW1iZXIgPSAwLFxyXG4gICAgbGlrZUNvdW50OiBudW1iZXIgPSAwLFxyXG4gICAgY29tbWVudENvdW50OiBudW1iZXIgPSAwXHJcbiAgKTogUHJvbWlzZTxWaWRlb01ldGFkYXRhPiB7XHJcbiAgICBjb25zdCB1cGRhdGVkSXRlbSA9IGF3YWl0IHRoaXMudXBkYXRlKHtcclxuICAgICAgS2V5OiB7IHZpZGVvSWQgfSxcclxuICAgICAgVXBkYXRlRXhwcmVzc2lvbjogYFxyXG4gICAgICAgIFNFVCB5b3V0dWJlSWQgPSA6eW91dHViZUlkLFxyXG4gICAgICAgICAgICB2aWV3Q291bnQgPSA6dmlld0NvdW50LFxyXG4gICAgICAgICAgICBsaWtlQ291bnQgPSA6bGlrZUNvdW50LFxyXG4gICAgICAgICAgICBjb21tZW50Q291bnQgPSA6Y29tbWVudENvdW50LFxyXG4gICAgICAgICAgICAjc3RhdHVzID0gOnN0YXR1cyxcclxuICAgICAgICAgICAgdXBkYXRlZEF0ID0gOnVwZGF0ZWRBdFxyXG4gICAgICBgLFxyXG4gICAgICBFeHByZXNzaW9uQXR0cmlidXRlTmFtZXM6IHtcclxuICAgICAgICAnI3N0YXR1cyc6ICdzdGF0dXMnXHJcbiAgICAgIH0sXHJcbiAgICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXM6IHtcclxuICAgICAgICAnOnlvdXR1YmVJZCc6IHlvdXR1YmVJZCxcclxuICAgICAgICAnOnZpZXdDb3VudCc6IHZpZXdDb3VudCxcclxuICAgICAgICAnOmxpa2VDb3VudCc6IGxpa2VDb3VudCxcclxuICAgICAgICAnOmNvbW1lbnRDb3VudCc6IGNvbW1lbnRDb3VudCxcclxuICAgICAgICAnOnN0YXR1cyc6IFZpZGVvU3RhdHVzLlBVQkxJU0hFRCxcclxuICAgICAgICAnOnVwZGF0ZWRBdCc6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKVxyXG4gICAgICB9LFxyXG4gICAgICBSZXR1cm5WYWx1ZXM6ICdBTExfTkVXJ1xyXG4gICAgfSk7XHJcblxyXG4gICAgcmV0dXJuIFZpZGVvTWV0YWRhdGFNb2RlbC5mcm9tRHluYW1vRGJJdGVtKHVwZGF0ZWRJdGVtKTtcclxuICB9XHJcblxyXG4gIGFzeW5jIHVwZGF0ZVBlcmZvcm1hbmNlTWV0cmljcyhcclxuICAgIHZpZGVvSWQ6IHN0cmluZyxcclxuICAgIG1ldHJpY3M6IFBhcnRpYWw8UGVyZm9ybWFuY2VNZXRyaWNzPlxyXG4gICk6IFByb21pc2U8VmlkZW9NZXRhZGF0YT4ge1xyXG4gICAgY29uc3QgZXhpc3RpbmdWaWRlbyA9IGF3YWl0IHRoaXMuZ2V0VmlkZW8odmlkZW9JZCk7XHJcbiAgICBpZiAoIWV4aXN0aW5nVmlkZW8pIHtcclxuICAgICAgdGhyb3cgbmV3IEVycm9yKGBWaWRlbyB3aXRoIElEICR7dmlkZW9JZH0gbm90IGZvdW5kYCk7XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgdXBkYXRlZE1ldHJpY3MgPSB7XHJcbiAgICAgIC4uLmV4aXN0aW5nVmlkZW8ucGVyZm9ybWFuY2VNZXRyaWNzLFxyXG4gICAgICAuLi5tZXRyaWNzXHJcbiAgICB9O1xyXG5cclxuICAgIGNvbnN0IHVwZGF0ZWRJdGVtID0gYXdhaXQgdGhpcy51cGRhdGUoe1xyXG4gICAgICBLZXk6IHsgdmlkZW9JZCB9LFxyXG4gICAgICBVcGRhdGVFeHByZXNzaW9uOiAnU0VUIHBlcmZvcm1hbmNlTWV0cmljcyA9IDptZXRyaWNzLCB1cGRhdGVkQXQgPSA6dXBkYXRlZEF0JyxcclxuICAgICAgRXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlczoge1xyXG4gICAgICAgICc6bWV0cmljcyc6IHVwZGF0ZWRNZXRyaWNzLFxyXG4gICAgICAgICc6dXBkYXRlZEF0JzogbmV3IERhdGUoKS50b0lTT1N0cmluZygpXHJcbiAgICAgIH0sXHJcbiAgICAgIFJldHVyblZhbHVlczogJ0FMTF9ORVcnXHJcbiAgICB9KTtcclxuXHJcbiAgICByZXR1cm4gVmlkZW9NZXRhZGF0YU1vZGVsLmZyb21EeW5hbW9EYkl0ZW0odXBkYXRlZEl0ZW0pO1xyXG4gIH1cclxuXHJcbiAgYXN5bmMgZ2V0VmlkZW9zQnlTdGF0dXMoc3RhdHVzOiBWaWRlb1N0YXR1cywgbGltaXQ6IG51bWJlciA9IDUwKTogUHJvbWlzZTxWaWRlb01ldGFkYXRhW10+IHtcclxuICAgIGNvbnN0IGl0ZW1zID0gYXdhaXQgdGhpcy5zY2FuKHtcclxuICAgICAgRmlsdGVyRXhwcmVzc2lvbjogJyNzdGF0dXMgPSA6c3RhdHVzJyxcclxuICAgICAgRXhwcmVzc2lvbkF0dHJpYnV0ZU5hbWVzOiB7XHJcbiAgICAgICAgJyNzdGF0dXMnOiAnc3RhdHVzJ1xyXG4gICAgICB9LFxyXG4gICAgICBFeHByZXNzaW9uQXR0cmlidXRlVmFsdWVzOiB7XHJcbiAgICAgICAgJzpzdGF0dXMnOiBzdGF0dXNcclxuICAgICAgfSxcclxuICAgICAgTGltaXQ6IGxpbWl0XHJcbiAgICB9KTtcclxuXHJcbiAgICByZXR1cm4gaXRlbXMubWFwKGl0ZW0gPT4gVmlkZW9NZXRhZGF0YU1vZGVsLmZyb21EeW5hbW9EYkl0ZW0oaXRlbSkpO1xyXG4gIH1cclxuXHJcbiAgYXN5bmMgZ2V0VmlkZW9zQnlEYXRlUmFuZ2UoXHJcbiAgICBzdGFydERhdGU6IHN0cmluZyxcclxuICAgIGVuZERhdGU6IHN0cmluZyxcclxuICAgIG9wdGlvbnM6IFZpZGVvUXVlcnlPcHRpb25zID0ge31cclxuICApOiBQcm9taXNlPFZpZGVvTWV0YWRhdGFbXT4ge1xyXG4gICAgbGV0IGZpbHRlckV4cHJlc3Npb24gPSAndXBsb2FkRGF0ZSBCRVRXRUVOIDpzdGFydERhdGUgQU5EIDplbmREYXRlJztcclxuICAgIGNvbnN0IGV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXM6IFJlY29yZDxzdHJpbmcsIGFueT4gPSB7XHJcbiAgICAgICc6c3RhcnREYXRlJzogc3RhcnREYXRlLFxyXG4gICAgICAnOmVuZERhdGUnOiBlbmREYXRlXHJcbiAgICB9O1xyXG5cclxuICAgIGlmIChvcHRpb25zLnN0YXR1cykge1xyXG4gICAgICBmaWx0ZXJFeHByZXNzaW9uICs9ICcgQU5EICNzdGF0dXMgPSA6c3RhdHVzJztcclxuICAgICAgZXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlc1snOnN0YXR1cyddID0gb3B0aW9ucy5zdGF0dXM7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gVXNlIHNjYW4gaW5zdGVhZCBvZiBxdWVyeSBzaW5jZSB3ZSBuZWVkIHRvIGZpbHRlciBieSBkYXRlIHJhbmdlXHJcbiAgICAvLyBhbmQgdGhlIEdTSSBvbmx5IGhhcyB1cGxvYWREYXRlIGFzIHBhcnRpdGlvbiBrZXlcclxuICAgIGNvbnN0IGl0ZW1zID0gYXdhaXQgdGhpcy5zY2FuKHtcclxuICAgICAgRmlsdGVyRXhwcmVzc2lvbjogZmlsdGVyRXhwcmVzc2lvbixcclxuICAgICAgRXhwcmVzc2lvbkF0dHJpYnV0ZU5hbWVzOiBvcHRpb25zLnN0YXR1cyA/IHsgJyNzdGF0dXMnOiAnc3RhdHVzJyB9IDogdW5kZWZpbmVkLFxyXG4gICAgICBFeHByZXNzaW9uQXR0cmlidXRlVmFsdWVzOiBleHByZXNzaW9uQXR0cmlidXRlVmFsdWVzLFxyXG4gICAgICBMaW1pdDogb3B0aW9ucy5saW1pdFxyXG4gICAgfSk7XHJcblxyXG4gICAgLy8gU29ydCBieSB1cGxvYWQgZGF0ZSBkZXNjZW5kaW5nIChtb3N0IHJlY2VudCBmaXJzdClcclxuICAgIGNvbnN0IHNvcnRlZEl0ZW1zID0gaXRlbXMuc29ydCgoYSwgYikgPT4gXHJcbiAgICAgIG5ldyBEYXRlKGIudXBsb2FkRGF0ZSkuZ2V0VGltZSgpIC0gbmV3IERhdGUoYS51cGxvYWREYXRlKS5nZXRUaW1lKClcclxuICAgICk7XHJcblxyXG4gICAgcmV0dXJuIHNvcnRlZEl0ZW1zLm1hcChpdGVtID0+IFZpZGVvTWV0YWRhdGFNb2RlbC5mcm9tRHluYW1vRGJJdGVtKGl0ZW0pKTtcclxuICB9XHJcblxyXG4gIGFzeW5jIGdldFJlY2VudFZpZGVvcyhkYXlzOiBudW1iZXIgPSA3LCBsaW1pdDogbnVtYmVyID0gNTApOiBQcm9taXNlPFZpZGVvTWV0YWRhdGFbXT4ge1xyXG4gICAgY29uc3Qgc3RhcnREYXRlID0gbmV3IERhdGUoRGF0ZS5ub3coKSAtIGRheXMgKiAyNCAqIDYwICogNjAgKiAxMDAwKVxyXG4gICAgICAudG9JU09TdHJpbmcoKVxyXG4gICAgICAuc3BsaXQoJ1QnKVswXTtcclxuICAgIGNvbnN0IGVuZERhdGUgPSBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCkuc3BsaXQoJ1QnKVswXTtcclxuXHJcbiAgICByZXR1cm4gdGhpcy5nZXRWaWRlb3NCeURhdGVSYW5nZShzdGFydERhdGUsIGVuZERhdGUsIHsgbGltaXQgfSk7XHJcbiAgfVxyXG5cclxuICBhc3luYyBnZXRUb3BQZXJmb3JtaW5nVmlkZW9zKFxyXG4gICAgZGF5czogbnVtYmVyID0gMzAsXHJcbiAgICBsaW1pdDogbnVtYmVyID0gMTBcclxuICApOiBQcm9taXNlPFZpZGVvTWV0YWRhdGFbXT4ge1xyXG4gICAgY29uc3Qgc3RhcnREYXRlID0gbmV3IERhdGUoRGF0ZS5ub3coKSAtIGRheXMgKiAyNCAqIDYwICogNjAgKiAxMDAwKVxyXG4gICAgICAudG9JU09TdHJpbmcoKVxyXG4gICAgICAuc3BsaXQoJ1QnKVswXTtcclxuICAgIGNvbnN0IGVuZERhdGUgPSBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCkuc3BsaXQoJ1QnKVswXTtcclxuXHJcbiAgICBjb25zdCB2aWRlb3MgPSBhd2FpdCB0aGlzLmdldFZpZGVvc0J5RGF0ZVJhbmdlKHN0YXJ0RGF0ZSwgZW5kRGF0ZSk7XHJcbiAgICBcclxuICAgIHJldHVybiB2aWRlb3NcclxuICAgICAgLmZpbHRlcih2aWRlbyA9PiB2aWRlby5zdGF0dXMgPT09IFZpZGVvU3RhdHVzLlBVQkxJU0hFRClcclxuICAgICAgLnNvcnQoKGEsIGIpID0+IHtcclxuICAgICAgICAvLyBTb3J0IGJ5IGVuZ2FnZW1lbnQgcmF0ZSwgdGhlbiBieSB2aWV3IGNvdW50XHJcbiAgICAgICAgY29uc3QgYUVuZ2FnZW1lbnQgPSAoYS5saWtlQ291bnQgKyBhLmNvbW1lbnRDb3VudCkgLyBNYXRoLm1heChhLnZpZXdDb3VudCwgMSk7XHJcbiAgICAgICAgY29uc3QgYkVuZ2FnZW1lbnQgPSAoYi5saWtlQ291bnQgKyBiLmNvbW1lbnRDb3VudCkgLyBNYXRoLm1heChiLnZpZXdDb3VudCwgMSk7XHJcbiAgICAgICAgXHJcbiAgICAgICAgaWYgKGFFbmdhZ2VtZW50ICE9PSBiRW5nYWdlbWVudCkge1xyXG4gICAgICAgICAgcmV0dXJuIGJFbmdhZ2VtZW50IC0gYUVuZ2FnZW1lbnQ7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIFxyXG4gICAgICAgIHJldHVybiBiLnZpZXdDb3VudCAtIGEudmlld0NvdW50O1xyXG4gICAgICB9KVxyXG4gICAgICAuc2xpY2UoMCwgbGltaXQpO1xyXG4gIH1cclxuXHJcbiAgYXN5bmMgZ2V0VmlkZW9BbmFseXRpY3MoZGF5czogbnVtYmVyID0gMzApOiBQcm9taXNlPHtcclxuICAgIHRvdGFsVmlkZW9zOiBudW1iZXI7XHJcbiAgICBwdWJsaXNoZWRWaWRlb3M6IG51bWJlcjtcclxuICAgIHRvdGFsVmlld3M6IG51bWJlcjtcclxuICAgIHRvdGFsUmV2ZW51ZTogbnVtYmVyO1xyXG4gICAgYXZlcmFnZVJPSTogbnVtYmVyO1xyXG4gICAgdG90YWxDb3N0czogbnVtYmVyO1xyXG4gICAgc3RhdHVzQnJlYWtkb3duOiBSZWNvcmQ8VmlkZW9TdGF0dXMsIG51bWJlcj47XHJcbiAgfT4ge1xyXG4gICAgY29uc3Qgc3RhcnREYXRlID0gbmV3IERhdGUoRGF0ZS5ub3coKSAtIGRheXMgKiAyNCAqIDYwICogNjAgKiAxMDAwKVxyXG4gICAgICAudG9JU09TdHJpbmcoKVxyXG4gICAgICAuc3BsaXQoJ1QnKVswXTtcclxuICAgIGNvbnN0IGVuZERhdGUgPSBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCkuc3BsaXQoJ1QnKVswXTtcclxuXHJcbiAgICBjb25zdCB2aWRlb3MgPSBhd2FpdCB0aGlzLmdldFZpZGVvc0J5RGF0ZVJhbmdlKHN0YXJ0RGF0ZSwgZW5kRGF0ZSk7XHJcblxyXG4gICAgY29uc3Qgc3RhdHVzQnJlYWtkb3duID0gT2JqZWN0LnZhbHVlcyhWaWRlb1N0YXR1cykucmVkdWNlKChhY2MsIHN0YXR1cykgPT4ge1xyXG4gICAgICBhY2Nbc3RhdHVzXSA9IDA7XHJcbiAgICAgIHJldHVybiBhY2M7XHJcbiAgICB9LCB7fSBhcyBSZWNvcmQ8VmlkZW9TdGF0dXMsIG51bWJlcj4pO1xyXG5cclxuICAgIGxldCB0b3RhbFZpZXdzID0gMDtcclxuICAgIGxldCB0b3RhbFJldmVudWUgPSAwO1xyXG4gICAgbGV0IHRvdGFsQ29zdHMgPSAwO1xyXG4gICAgbGV0IHRvdGFsUk9JID0gMDtcclxuICAgIGxldCBwdWJsaXNoZWRWaWRlb3MgPSAwO1xyXG5cclxuICAgIHZpZGVvcy5mb3JFYWNoKHZpZGVvID0+IHtcclxuICAgICAgc3RhdHVzQnJlYWtkb3duW3ZpZGVvLnN0YXR1c10rKztcclxuICAgICAgXHJcbiAgICAgIGlmICh2aWRlby5zdGF0dXMgPT09IFZpZGVvU3RhdHVzLlBVQkxJU0hFRCkge1xyXG4gICAgICAgIHB1Ymxpc2hlZFZpZGVvcysrO1xyXG4gICAgICAgIHRvdGFsVmlld3MgKz0gdmlkZW8udmlld0NvdW50O1xyXG4gICAgICAgIHRvdGFsUmV2ZW51ZSArPSB2aWRlby5yZXZlbnVlO1xyXG4gICAgICB9XHJcbiAgICAgIFxyXG4gICAgICB0b3RhbENvc3RzICs9IHZpZGVvLmdlbmVyYXRpb25Db3N0ICsgdmlkZW8ucHJvY2Vzc2luZ0Nvc3Q7XHJcbiAgICAgIHRvdGFsUk9JICs9IFZpZGVvTWV0YWRhdGFNb2RlbC5jYWxjdWxhdGVST0kodmlkZW8pO1xyXG4gICAgfSk7XHJcblxyXG4gICAgcmV0dXJuIHtcclxuICAgICAgdG90YWxWaWRlb3M6IHZpZGVvcy5sZW5ndGgsXHJcbiAgICAgIHB1Ymxpc2hlZFZpZGVvcyxcclxuICAgICAgdG90YWxWaWV3cyxcclxuICAgICAgdG90YWxSZXZlbnVlLFxyXG4gICAgICBhdmVyYWdlUk9JOiB2aWRlb3MubGVuZ3RoID4gMCA/IHRvdGFsUk9JIC8gdmlkZW9zLmxlbmd0aCA6IDAsXHJcbiAgICAgIHRvdGFsQ29zdHMsXHJcbiAgICAgIHN0YXR1c0JyZWFrZG93blxyXG4gICAgfTtcclxuICB9XHJcblxyXG4gIGFzeW5jIGRlbGV0ZVZpZGVvKHZpZGVvSWQ6IHN0cmluZyk6IFByb21pc2U8dm9pZD4ge1xyXG4gICAgYXdhaXQgdGhpcy5kZWxldGUoe1xyXG4gICAgICBLZXk6IHsgdmlkZW9JZCB9XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIGFzeW5jIGdldFZpZGVvc0J5U291cmNlVHJlbmQodHJlbmRUb3BpYzogc3RyaW5nLCBsaW1pdDogbnVtYmVyID0gMjApOiBQcm9taXNlPFZpZGVvTWV0YWRhdGFbXT4ge1xyXG4gICAgY29uc3QgaXRlbXMgPSBhd2FpdCB0aGlzLnNjYW4oe1xyXG4gICAgICBGaWx0ZXJFeHByZXNzaW9uOiAnY29udGFpbnMoc291cmNlVHJlbmRzLCA6dHJlbmRUb3BpYyknLFxyXG4gICAgICBFeHByZXNzaW9uQXR0cmlidXRlVmFsdWVzOiB7XHJcbiAgICAgICAgJzp0cmVuZFRvcGljJzogdHJlbmRUb3BpY1xyXG4gICAgICB9LFxyXG4gICAgICBMaW1pdDogbGltaXRcclxuICAgIH0pO1xyXG5cclxuICAgIHJldHVybiBpdGVtcy5tYXAoaXRlbSA9PiBWaWRlb01ldGFkYXRhTW9kZWwuZnJvbUR5bmFtb0RiSXRlbShpdGVtKSk7XHJcbiAgfVxyXG5cclxuICBhc3luYyB1cGRhdGVDb3N0cyhcclxuICAgIHZpZGVvSWQ6IHN0cmluZyxcclxuICAgIGdlbmVyYXRpb25Db3N0PzogbnVtYmVyLFxyXG4gICAgcHJvY2Vzc2luZ0Nvc3Q/OiBudW1iZXJcclxuICApOiBQcm9taXNlPFZpZGVvTWV0YWRhdGE+IHtcclxuICAgIGNvbnN0IHVwZGF0ZUV4cHJlc3Npb25zOiBzdHJpbmdbXSA9IFtdO1xyXG4gICAgY29uc3QgZXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlczogUmVjb3JkPHN0cmluZywgYW55PiA9IHtcclxuICAgICAgJzp1cGRhdGVkQXQnOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKClcclxuICAgIH07XHJcblxyXG4gICAgaWYgKGdlbmVyYXRpb25Db3N0ICE9PSB1bmRlZmluZWQpIHtcclxuICAgICAgdXBkYXRlRXhwcmVzc2lvbnMucHVzaCgnZ2VuZXJhdGlvbkNvc3QgPSA6Z2VuZXJhdGlvbkNvc3QnKTtcclxuICAgICAgZXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlc1snOmdlbmVyYXRpb25Db3N0J10gPSBnZW5lcmF0aW9uQ29zdDtcclxuICAgIH1cclxuXHJcbiAgICBpZiAocHJvY2Vzc2luZ0Nvc3QgIT09IHVuZGVmaW5lZCkge1xyXG4gICAgICB1cGRhdGVFeHByZXNzaW9ucy5wdXNoKCdwcm9jZXNzaW5nQ29zdCA9IDpwcm9jZXNzaW5nQ29zdCcpO1xyXG4gICAgICBleHByZXNzaW9uQXR0cmlidXRlVmFsdWVzWyc6cHJvY2Vzc2luZ0Nvc3QnXSA9IHByb2Nlc3NpbmdDb3N0O1xyXG4gICAgfVxyXG5cclxuICAgIHVwZGF0ZUV4cHJlc3Npb25zLnB1c2goJ3VwZGF0ZWRBdCA9IDp1cGRhdGVkQXQnKTtcclxuXHJcbiAgICBjb25zdCB1cGRhdGVkSXRlbSA9IGF3YWl0IHRoaXMudXBkYXRlKHtcclxuICAgICAgS2V5OiB7IHZpZGVvSWQgfSxcclxuICAgICAgVXBkYXRlRXhwcmVzc2lvbjogYFNFVCAke3VwZGF0ZUV4cHJlc3Npb25zLmpvaW4oJywgJyl9YCxcclxuICAgICAgRXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlczogZXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlcyxcclxuICAgICAgUmV0dXJuVmFsdWVzOiAnQUxMX05FVydcclxuICAgIH0pO1xyXG5cclxuICAgIHJldHVybiBWaWRlb01ldGFkYXRhTW9kZWwuZnJvbUR5bmFtb0RiSXRlbSh1cGRhdGVkSXRlbSk7XHJcbiAgfVxyXG59Il19