"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const lib_dynamodb_1 = require("@aws-sdk/lib-dynamodb");
const handler = async (event, context) => {
    const startTime = Date.now();
    console.log('Fallback Trend Provider started', {
        requestId: context.awsRequestId,
        topics: event.topics,
        strategy: event.fallbackStrategy,
        workflowId: event.workflowContext.workflowId
    });
    try {
        let results = [];
        switch (event.fallbackStrategy) {
            case 'CACHED_TRENDS':
                results = await getCachedTrends(event.topics);
                break;
            case 'POPULAR_KEYWORDS':
                results = await generateFromPopularKeywords(event.topics);
                break;
            case 'TEMPLATE_BASED':
                results = await generateFromTemplates(event.topics);
                break;
            default:
                throw new Error(`Unknown fallback strategy: ${event.fallbackStrategy}`);
        }
        const totalTrends = results.reduce((sum, result) => sum + result.trendsFound, 0);
        console.log('Fallback trend provider completed successfully', {
            strategy: event.fallbackStrategy,
            topicsProcessed: results.length,
            totalTrends,
            executionTime: Date.now() - startTime
        });
        return {
            success: true,
            trendsDetected: totalTrends,
            topicsAnalyzed: results.length,
            results,
            executionTime: Date.now() - startTime
        };
    }
    catch (error) {
        console.error('Fallback trend provider failed', {
            error: error instanceof Error ? error.message : String(error),
            stack: error instanceof Error ? error.stack : undefined,
            requestId: context.awsRequestId
        });
        return {
            success: false,
            trendsDetected: 0,
            topicsAnalyzed: 0,
            results: [],
            executionTime: Date.now() - startTime,
            error: error instanceof Error ? error.message : String(error)
        };
    }
};
exports.handler = handler;
async function getCachedTrends(topics) {
    console.log('Retrieving cached trends from DynamoDB');
    const client = new client_dynamodb_1.DynamoDBClient({ region: process.env.AWS_REGION });
    const docClient = lib_dynamodb_1.DynamoDBDocumentClient.from(client);
    const results = [];
    for (const topic of topics) {
        try {
            // Get trends from last 24 hours
            const cutoffTime = new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString();
            const response = await docClient.send(new lib_dynamodb_1.QueryCommand({
                TableName: process.env.TREND_ANALYTICS_TABLE_NAME || 'TrendAnalytics',
                KeyConditionExpression: '#topic = :topic AND #timestamp >= :cutoffTime',
                ExpressionAttributeNames: {
                    '#topic': 'topic',
                    '#timestamp': 'timestamp'
                },
                ExpressionAttributeValues: {
                    ':topic': topic,
                    ':cutoffTime': cutoffTime
                },
                Limit: 20,
                ScanIndexForward: false // Most recent first
            }));
            const trends = response.Items || [];
            if (trends.length > 0) {
                const topTrend = trends[0];
                const averageEngagement = trends.reduce((sum, trend) => sum + (trend.engagementScore || 0), 0) / trends.length;
                results.push({
                    topic,
                    trends,
                    topTrend,
                    trendsFound: trends.length,
                    averageEngagement,
                    source: 'CACHED'
                });
                console.log(`Found ${trends.length} cached trends for topic: ${topic}`);
            }
            else {
                // No cached trends, create fallback
                const fallbackTrend = createFallbackTrend(topic);
                results.push({
                    topic,
                    trends: [fallbackTrend],
                    topTrend: fallbackTrend,
                    trendsFound: 1,
                    averageEngagement: 0.03,
                    source: 'CACHED'
                });
                console.log(`No cached trends found for topic: ${topic}, using fallback`);
            }
        }
        catch (error) {
            console.error(`Failed to get cached trends for topic: ${topic}`, error);
            // Create minimal fallback
            const fallbackTrend = createFallbackTrend(topic);
            results.push({
                topic,
                trends: [fallbackTrend],
                topTrend: fallbackTrend,
                trendsFound: 1,
                averageEngagement: 0.02,
                source: 'CACHED'
            });
        }
    }
    return results;
}
async function generateFromPopularKeywords(topics) {
    console.log('Generating trends from popular keywords');
    const popularKeywordsByTopic = {
        investing: ['ETF', 'stocks', 'portfolio', 'dividends', 'crypto', 'retirement', 'savings', 'market'],
        education: ['study', 'learning', 'skills', 'courses', 'tutorial', 'tips', 'productivity', 'success'],
        tourism: ['travel', 'destinations', 'vacation', 'adventure', 'culture', 'food', 'budget', 'guide'],
        technology: ['AI', 'software', 'gadgets', 'innovation', 'coding', 'apps', 'future', 'trends'],
        health: ['fitness', 'nutrition', 'wellness', 'exercise', 'diet', 'mental', 'lifestyle', 'tips'],
        finance: ['money', 'budget', 'savings', 'debt', 'credit', 'loans', 'planning', 'wealth']
    };
    const results = [];
    for (const topic of topics) {
        const keywords = popularKeywordsByTopic[topic.toLowerCase()] || ['tips', 'guide', 'tutorial', 'best'];
        const trends = [];
        // Generate synthetic trends based on popular keywords
        for (let i = 0; i < Math.min(5, keywords.length); i++) {
            const keyword = keywords[i];
            const trend = {
                topic,
                timestamp: new Date().toISOString(),
                videoId: `fallback_${topic}_${keyword}_${Date.now()}_${i}`,
                title: `${keyword} ${topic} Guide: Essential Tips for Beginners`,
                viewCount: Math.floor(Math.random() * 50000) + 10000,
                likeCount: Math.floor(Math.random() * 2000) + 500,
                commentCount: Math.floor(Math.random() * 300) + 50,
                engagementRate: Math.random() * 3 + 2,
                engagementScore: Math.random() * 0.03 + 0.02,
                keywords: [keyword, topic, 'guide', 'tips', 'tutorial'],
                categoryId: '27',
                publishedAt: new Date(Date.now() - Math.random() * 24 * 60 * 60 * 1000).toISOString(),
                channelTitle: `${topic} Expert`,
                channelId: `fallback_channel_${topic}`,
                description: `Learn about ${keyword} in ${topic} with this comprehensive guide`
            };
            trends.push(trend);
        }
        const topTrend = trends[0];
        const averageEngagement = trends.reduce((sum, trend) => sum + trend.engagementScore, 0) / trends.length;
        results.push({
            topic,
            trends,
            topTrend,
            trendsFound: trends.length,
            averageEngagement,
            source: 'FALLBACK_KEYWORDS'
        });
        console.log(`Generated ${trends.length} fallback trends for topic: ${topic}`);
    }
    return results;
}
async function generateFromTemplates(topics) {
    console.log('Generating trends from templates');
    const templates = [
        'Ultimate {topic} Guide for Beginners',
        'Top 10 {topic} Tips Everyone Should Know',
        '{topic} Mistakes to Avoid in 2024',
        'Complete {topic} Tutorial: Step by Step',
        'Best {topic} Strategies That Actually Work'
    ];
    const results = [];
    for (const topic of topics) {
        const trends = [];
        for (let i = 0; i < templates.length; i++) {
            const template = templates[i];
            const title = template.replace('{topic}', topic.charAt(0).toUpperCase() + topic.slice(1));
            const trend = {
                topic,
                timestamp: new Date().toISOString(),
                videoId: `template_${topic}_${Date.now()}_${i}`,
                title,
                viewCount: Math.floor(Math.random() * 30000) + 5000,
                likeCount: Math.floor(Math.random() * 1500) + 300,
                commentCount: Math.floor(Math.random() * 200) + 30,
                engagementRate: Math.random() * 2.5 + 1.5,
                engagementScore: Math.random() * 0.025 + 0.015,
                keywords: [topic, 'guide', 'tips', 'tutorial', 'beginners'],
                categoryId: '27',
                publishedAt: new Date(Date.now() - Math.random() * 12 * 60 * 60 * 1000).toISOString(),
                channelTitle: `${topic} Academy`,
                channelId: `template_channel_${topic}`,
                description: `Comprehensive ${topic} content for learners of all levels`
            };
            trends.push(trend);
        }
        const topTrend = trends[0];
        const averageEngagement = trends.reduce((sum, trend) => sum + trend.engagementScore, 0) / trends.length;
        results.push({
            topic,
            trends,
            topTrend,
            trendsFound: trends.length,
            averageEngagement,
            source: 'TEMPLATE'
        });
        console.log(`Generated ${trends.length} template-based trends for topic: ${topic}`);
    }
    return results;
}
function createFallbackTrend(topic) {
    return {
        topic,
        timestamp: new Date().toISOString(),
        videoId: `fallback_${topic}_${Date.now()}`,
        title: `Essential ${topic.charAt(0).toUpperCase() + topic.slice(1)} Guide`,
        viewCount: 15000,
        likeCount: 750,
        commentCount: 100,
        engagementRate: 5.67,
        engagementScore: 0.057,
        keywords: [topic, 'guide', 'essential', 'tips'],
        categoryId: '27',
        publishedAt: new Date(Date.now() - 6 * 60 * 60 * 1000).toISOString(),
        channelTitle: `${topic} Basics`,
        channelId: `fallback_${topic}`,
        description: `Basic ${topic} information and guidance`
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFDQSw4REFBMEQ7QUFDMUQsd0RBQTBGO0FBNEJuRixNQUFNLE9BQU8sR0FBdUUsS0FBSyxFQUM5RixLQUFpQyxFQUNqQyxPQUFnQixFQUN3QixFQUFFO0lBQzFDLE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQztJQUU3QixPQUFPLENBQUMsR0FBRyxDQUFDLGlDQUFpQyxFQUFFO1FBQzdDLFNBQVMsRUFBRSxPQUFPLENBQUMsWUFBWTtRQUMvQixNQUFNLEVBQUUsS0FBSyxDQUFDLE1BQU07UUFDcEIsUUFBUSxFQUFFLEtBQUssQ0FBQyxnQkFBZ0I7UUFDaEMsVUFBVSxFQUFFLEtBQUssQ0FBQyxlQUFlLENBQUMsVUFBVTtLQUM3QyxDQUFDLENBQUM7SUFFSCxJQUFJO1FBQ0YsSUFBSSxPQUFPLEdBQVUsRUFBRSxDQUFDO1FBRXhCLFFBQVEsS0FBSyxDQUFDLGdCQUFnQixFQUFFO1lBQzlCLEtBQUssZUFBZTtnQkFDbEIsT0FBTyxHQUFHLE1BQU0sZUFBZSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQztnQkFDOUMsTUFBTTtZQUNSLEtBQUssa0JBQWtCO2dCQUNyQixPQUFPLEdBQUcsTUFBTSwyQkFBMkIsQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUM7Z0JBQzFELE1BQU07WUFDUixLQUFLLGdCQUFnQjtnQkFDbkIsT0FBTyxHQUFHLE1BQU0scUJBQXFCLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDO2dCQUNwRCxNQUFNO1lBQ1I7Z0JBQ0UsTUFBTSxJQUFJLEtBQUssQ0FBQyw4QkFBOEIsS0FBSyxDQUFDLGdCQUFnQixFQUFFLENBQUMsQ0FBQztTQUMzRTtRQUVELE1BQU0sV0FBVyxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQyxHQUFHLEVBQUUsTUFBTSxFQUFFLEVBQUUs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TyxDQUFDLEdBQUcsQ0FBQyxhQUFhLE1BQU0sQ0FBQyxNQUFNLHFDQUFxQyxLQUFLLEVBQUUsQ0FBQyxDQUFDO0tBQ3JGO0lBRUQsT0FBTyxPQUFPLENBQUM7QUFDakIsQ0FBQztBQUVELFNBQVMsbUJBQW1CLENBQUMsS0FBYTtJQUN4QyxPQUFPO1FBQ0wsS0FBSztRQUNMLFNBQVMsRUFBRSxJQUFJLElBQUksRUFBRSxDQUFDLFdBQVcsRUFBRTtRQUNuQyxPQUFPLEVBQUUsWUFBWSxLQUFLLElBQUksSUFBSSxDQUFDLEdBQUcsRUFBRSxFQUFFO1FBQzFDLEtBQUssRUFBRSxhQUFhLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsV0FBVyxFQUFFLEdBQUcsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsUUFBUTtRQUMxRSxTQUFTLEVBQUUsS0FBSztRQUNoQixTQUFTLEVBQUUsR0FBRztRQUNkLFlBQVksRUFBRSxHQUFHO1FBQ2pCLGNBQWMsRUFBRSxJQUFJO1FBQ3BCLGVBQWUsRUFBRSxLQUFLO1FBQ3RCLFFBQVEsRUFBRSxDQUFDLEtBQUssRUFBRSxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sQ0FBQztRQUMvQyxVQUFVLEVBQUUsSUFBSTtRQUNoQixXQUFXLEVBQUUsSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRSxHQUFHLENBQUMsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLElBQUksQ0FBQyxDQUFDLFdBQVcsRUFBRTtRQUNwRSxZQUFZLEVBQUUsR0FBRyxLQUFLLFNBQVM7UUFDL0IsU0FBUyxFQUFFLFlBQVksS0FBSyxFQUFFO1FBQzlCLFdBQVcsRUFBRSxTQUFTLEtBQUssMkJBQTJCO0tBQ3ZELENBQUM7QUFDSixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSGFuZGxlciwgQ29udGV4dCB9IGZyb20gJ2F3cy1sYW1iZGEnO1xyXG5pbXBvcnQgeyBEeW5hbW9EQkNsaWVudCB9IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC1keW5hbW9kYic7XHJcbmltcG9ydCB7IER5bmFtb0RCRG9jdW1lbnRDbGllbnQsIFF1ZXJ5Q29tbWFuZCwgU2NhbkNvbW1hbmQgfSBmcm9tICdAYXdzLXNkay9saWItZHluYW1vZGInO1xyXG5cclxuZXhwb3J0IGludGVyZmFjZSBGYWxsYmFja1RyZW5kUHJvdmlkZXJFdmVudCB7XHJcbiAgdG9waWNzOiBzdHJpbmdbXTtcclxuICBmYWxsYmFja1N0cmF0ZWd5OiAnQ0FDSEVEX1RSRU5EUycgfCAnUE9QVUxBUl9LRVlXT1JEUycgfCAnVEVNUExBVEVfQkFTRUQnO1xyXG4gIHdvcmtmbG93Q29udGV4dDoge1xyXG4gICAgd29ya2Zsb3dJZDogc3RyaW5nO1xyXG4gICAgcmV0cnlDb3VudDogbnVtYmVyO1xyXG4gICAgZmFpbHVyZUNvdW50OiBudW1iZXI7XHJcbiAgfTtcclxufVxyXG5cclxuZXhwb3J0IGludGVyZmFjZSBGYWxsYmFja1RyZW5kUHJvdmlkZXJSZXNwb25zZSB7XHJcbiAgc3VjY2VzczogYm9vbGVhbjtcclxuICB0cmVuZHNEZXRlY3RlZDogbnVtYmVyO1xyXG4gIHRvcGljc0FuYWx5emVkOiBudW1iZXI7XHJcbiAgcmVzdWx0czogQXJyYXk8e1xyXG4gICAgdG9waWM6IHN0cmluZztcclxuICAgIHRyZW5kczogYW55W107XHJcbiAgICB0b3BUcmVuZDogYW55O1xyXG4gICAgdHJlbmRzRm91bmQ6IG51bWJlcjtcclxuICAgIGF2ZXJhZ2VFbmdhZ2VtZW50OiBudW1iZXI7XHJcbiAgICBzb3VyY2U6ICdDQUNIRUQnIHwgJ0ZBTExCQUNLX0tFWVdPUkRTJyB8ICdURU1QTEFURSc7XHJcbiAgfT47XHJcbiAgZXhlY3V0aW9uVGltZTogbnVtYmVyO1xyXG4gIGVycm9yPzogc3RyaW5nO1xyXG59XHJcblxyXG5leHBvcnQgY29uc3QgaGFuZGxlcjogSGFuZGxlcjxGYWxsYmFja1RyZW5kUHJvdmlkZXJFdmVudCwgRmFsbGJhY2tUcmVuZFByb3ZpZGVyUmVzcG9uc2U+ID0gYXN5bmMgKFxyXG4gIGV2ZW50OiBGYWxsYmFja1RyZW5kUHJvdmlkZXJFdmVudCxcclxuICBjb250ZXh0OiBDb250ZXh0XHJcbik6IFByb21pc2U8RmFsbGJhY2tUcmVuZFByb3ZpZGVyUmVzcG9uc2U+ID0+IHtcclxuICBjb25zdCBzdGFydFRpbWUgPSBEYXRlLm5vdygpO1xyXG4gIFxyXG4gIGNvbnNvbGUubG9nKCdGYWxsYmFjayBUcmVuZCBQcm92aWRlciBzdGFydGVkJywge1xyXG4gICAgcmVxdWVzdElkOiBjb250ZXh0LmF3c1JlcXVlc3RJZCxcclxuICAgIHRvcGljczogZXZlbnQudG9waWNzLFxyXG4gICAgc3RyYXRlZ3k6IGV2ZW50LmZhbGxiYWNrU3RyYXRlZ3ksXHJcbiAgICB3b3JrZmxvd0lkOiBldmVudC53b3JrZmxvd0NvbnRleHQud29ya2Zsb3dJZFxyXG4gIH0pO1xyXG5cclxuICB0cnkge1xyXG4gICAgbGV0IHJlc3VsdHM6IGFueVtdID0gW107XHJcblxyXG4gICAgc3dpdGNoIChldmVudC5mYWxsYmFja1N0cmF0ZWd5KSB7XHJcbiAgICAgIGNhc2UgJ0NBQ0hFRF9UUkVORFMnOlxyXG4gICAgICAgIHJlc3VsdHMgPSBhd2FpdCBnZXRDYWNoZWRUcmVuZHMoZXZlbnQudG9waWNzKTtcclxuICAgICAgICBicmVhaztcclxuICAgICAgY2FzZSAnUE9QVUxBUl9LRVlXT1JEUyc6XHJcbiAgICAgICAgcmVzdWx0cyA9IGF3YWl0IGdlbmVyYXRlRnJvbVBvcHVsYXJLZXl3b3JkcyhldmVudC50b3BpY3MpO1xyXG4gICAgICAgIGJyZWFrO1xyXG4gICAgICBjYXNlICdURU1QTEFURV9CQVNFRCc6XHJcbiAgICAgICAgcmVzdWx0cyA9IGF3YWl0IGdlbmVyYXRlRnJvbVRlbXBsYXRlcyhldmVudC50b3BpY3MpO1xyXG4gICAgICAgIGJyZWFrO1xyXG4gICAgICBkZWZhdWx0OlxyXG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgVW5rbm93biBmYWxsYmFjayBzdHJhdGVneTogJHtldmVudC5mYWxsYmFja1N0cmF0ZWd5fWApO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IHRvdGFsVHJlbmRzID0gcmVzdWx0cy5yZWR1Y2UoKHN1bSwgcmVzdWx0KSA9PiBzdW0gKyByZXN1bHQudHJlbmRzRm91bmQsIDApO1xyXG5cclxuICAgIGNvbnNvbGUubG9nKCdGYWxsYmFjayB0cmVuZCBwcm92aWRlciBjb21wbGV0ZWQgc3VjY2Vzc2Z1bGx5Jywge1xyXG4gICAgICBzdHJhdGVneTogZXZlbnQuZmFsbGJhY2tTdHJhdGVneSxcclxuICAgICAgdG9waWNzUHJvY2Vzc2VkOiByZXN1bHRzLmxlbmd0aCxcclxuICAgICAgdG90YWxUcmVuZHMsXHJcbiAgICAgIGV4ZWN1dGlvblRpbWU6IERhdGUubm93KCkgLSBzdGFydFRpbWVcclxuICAgIH0pO1xyXG5cclxuICAgIHJldHVybiB7XHJcbiAgICAgIHN1Y2Nlc3M6IHRydWUsXHJcbiAgICAgIHRyZW5kc0RldGVjdGVkOiB0b3RhbFRyZW5kcyxcclxuICAgICAgdG9waWNzQW5hbHl6ZWQ6IHJlc3VsdHMubGVuZ3RoLFxyXG4gICAgICByZXN1bHRzLFxyXG4gICAgICBleGVjdXRpb25UaW1lOiBEYXRlLm5vdygpIC0gc3RhcnRUaW1lXHJcbiAgICB9O1xyXG5cclxuICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgY29uc29sZS5lcnJvcignRmFsbGJhY2sgdHJlbmQgcHJvdmlkZXIgZmFpbGVkJywge1xyXG4gICAgICBlcnJvcjogZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiBTdHJpbmcoZXJyb3IpLFxyXG4gICAgICBzdGFjazogZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLnN0YWNrIDogdW5kZWZpbmVkLFxyXG4gICAgICByZXF1ZXN0SWQ6IGNvbnRleHQuYXdzUmVxdWVzdElkXHJcbiAgICB9KTtcclxuXHJcbiAgICByZXR1cm4ge1xyXG4gICAgICBzdWNjZXNzOiBmYWxzZSxcclxuICAgICAgdHJlbmRzRGV0ZWN0ZWQ6IDAsXHJcbiAgICAgIHRvcGljc0FuYWx5emVkOiAwLFxyXG4gICAgICByZXN1bHRzOiBbXSxcclxuICAgICAgZXhlY3V0aW9uVGltZTogRGF0ZS5ub3coKSAtIHN0YXJ0VGltZSxcclxuICAgICAgZXJyb3I6IGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogU3RyaW5nKGVycm9yKVxyXG4gICAgfTtcclxuICB9XHJcbn07XHJcblxyXG5hc3luYyBmdW5jdGlvbiBnZXRDYWNoZWRUcmVuZHModG9waWNzOiBzdHJpbmdbXSk6IFByb21pc2U8YW55W10+IHtcclxuICBjb25zb2xlLmxvZygnUmV0cmlldmluZyBjYWNoZWQgdHJlbmRzIGZyb20gRHluYW1vREInKTtcclxuICBcclxuICBjb25zdCBjbGllbnQgPSBuZXcgRHluYW1vREJDbGllbnQoeyByZWdpb246IHByb2Nlc3MuZW52LkFXU19SRUdJT04gfSk7XHJcbiAgY29uc3QgZG9jQ2xpZW50ID0gRHluYW1vREJEb2N1bWVudENsaWVudC5mcm9tKGNsaWVudCk7XHJcbiAgXHJcbiAgY29uc3QgcmVzdWx0cyA9IFtdO1xyXG4gIFxyXG4gIGZvciAoY29uc3QgdG9waWMgb2YgdG9waWNzKSB7XHJcbiAgICB0cnkge1xyXG4gICAgICAvLyBHZXQgdHJlbmRzIGZyb20gbGFzdCAyNCBob3Vyc1xyXG4gICAgICBjb25zdCBjdXRvZmZUaW1lID0gbmV3IERhdGUoRGF0ZS5ub3coKSAtIDI0ICogNjAgKiA2MCAqIDEwMDApLnRvSVNPU3RyaW5nKCk7XHJcbiAgICAgIFxyXG4gICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGRvY0NsaWVudC5zZW5kKG5ldyBRdWVyeUNvbW1hbmQoe1xyXG4gICAgICAgIFRhYmxlTmFtZTogcHJvY2Vzcy5lbnYuVFJFTkRfQU5BTFlUSUNTX1RBQkxFX05BTUUgfHwgJ1RyZW5kQW5hbHl0aWNzJyxcclxuICAgICAgICBLZXlDb25kaXRpb25FeHByZXNzaW9uOiAnI3RvcGljID0gOnRvcGljIEFORCAjdGltZXN0YW1wID49IDpjdXRvZmZUaW1lJyxcclxuICAgICAgICBFeHByZXNzaW9uQXR0cmlidXRlTmFtZXM6IHtcclxuICAgICAgICAgICcjdG9waWMnOiAndG9waWMnLFxyXG4gICAgICAgICAgJyN0aW1lc3RhbXAnOiAndGltZXN0YW1wJ1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgRXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlczoge1xyXG4gICAgICAgICAgJzp0b3BpYyc6IHRvcGljLFxyXG4gICAgICAgICAgJzpjdXRvZmZUaW1lJzogY3V0b2ZmVGltZVxyXG4gICAgICAgIH0sXHJcbiAgICAgICAgTGltaXQ6IDIwLFxyXG4gICAgICAgIFNjYW5JbmRleEZvcndhcmQ6IGZhbHNlIC8vIE1vc3QgcmVjZW50IGZpcnN0XHJcbiAgICAgIH0pKTtcclxuXHJcbiAgICAgIGNvbnN0IHRyZW5kcyA9IHJlc3BvbnNlLkl0ZW1zIHx8IFtdO1xyXG4gICAgICBcclxuICAgICAgaWYgKHRyZW5kcy5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgY29uc3QgdG9wVHJlbmQgPSB0cmVuZHNbMF07XHJcbiAgICAgICAgY29uc3QgYXZlcmFnZUVuZ2FnZW1lbnQgPSB0cmVuZHMucmVkdWNlKChzdW0sIHRyZW5kKSA9PiBzdW0gKyAodHJlbmQuZW5nYWdlbWVudFNjb3JlIHx8IDApLCAwKSAvIHRyZW5kcy5sZW5ndGg7XHJcbiAgICAgICAgXHJcbiAgICAgICAgcmVzdWx0cy5wdXNoKHtcclxuICAgICAgICAgIHRvcGljLFxyXG4gICAgICAgICAgdHJlbmRzLFxyXG4gICAgICAgICAgdG9wVHJlbmQsXHJcbiAgICAgICAgICB0cmVuZHNGb3VuZDogdHJlbmRzLmxlbmd0aCxcclxuICAgICAgICAgIGF2ZXJhZ2VFbmdhZ2VtZW50LFxyXG4gICAgICAgICAgc291cmNlOiAnQ0FDSEVEJ1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIFxyXG4gICAgICAgIGNvbnNvbGUubG9nKGBGb3VuZCAke3RyZW5kcy5sZW5ndGh9IGNhY2hlZCB0cmVuZHMgZm9yIHRvcGljOiAke3RvcGljfWApO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIC8vIE5vIGNhY2hlZCB0cmVuZHMsIGNyZWF0ZSBmYWxsYmFja1xyXG4gICAgICAgIGNvbnN0IGZhbGxiYWNrVHJlbmQgPSBjcmVhdGVGYWxsYmFja1RyZW5kKHRvcGljKTtcclxuICAgICAgICByZXN1bHRzLnB1c2goe1xyXG4gICAgICAgICAgdG9waWMsXHJcbiAgICAgICAgICB0cmVuZHM6IFtmYWxsYmFja1RyZW5kXSxcclxuICAgICAgICAgIHRvcFRyZW5kOiBmYWxsYmFja1RyZW5kLFxyXG4gICAgICAgICAgdHJlbmRzRm91bmQ6IDEsXHJcbiAgICAgICAgICBhdmVyYWdlRW5nYWdlbWVudDogMC4wMyxcclxuICAgICAgICAgIHNvdXJjZTogJ0NBQ0hFRCdcclxuICAgICAgICB9KTtcclxuICAgICAgICBcclxuICAgICAgICBjb25zb2xlLmxvZyhgTm8gY2FjaGVkIHRyZW5kcyBmb3VuZCBmb3IgdG9waWM6ICR7dG9waWN9LCB1c2luZyBmYWxsYmFja2ApO1xyXG4gICAgICB9XHJcbiAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICBjb25zb2xlLmVycm9yKGBGYWlsZWQgdG8gZ2V0IGNhY2hlZCB0cmVuZHMgZm9yIHRvcGljOiAke3RvcGljfWAsIGVycm9yKTtcclxuICAgICAgXHJcbiAgICAgIC8vIENyZWF0ZSBtaW5pbWFsIGZhbGxiYWNrXHJcbiAgICAgIGNvbnN0IGZhbGxiYWNrVHJlbmQgPSBjcmVhdGVGYWxsYmFja1RyZW5kKHRvcGljKTtcclxuICAgICAgcmVzdWx0cy5wdXNoKHtcclxuICAgICAgICB0b3BpYyxcclxuICAgICAgICB0cmVuZHM6IFtmYWxsYmFja1RyZW5kXSxcclxuICAgICAgICB0b3BUcmVuZDogZmFsbGJhY2tUcmVuZCxcclxuICAgICAgICB0cmVuZHNGb3VuZDogMSxcclxuICAgICAgICBhdmVyYWdlRW5nYWdlbWVudDogMC4wMixcclxuICAgICAgICBzb3VyY2U6ICdDQUNIRUQnXHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG4gIH1cclxuICBcclxuICByZXR1cm4gcmVzdWx0cztcclxufVxyXG5cclxuYXN5bmMgZnVuY3Rpb24gZ2VuZXJhdGVGcm9tUG9wdWxhcktleXdvcmRzKHRvcGljczogc3RyaW5nW10pOiBQcm9taXNlPGFueVtdPiB7XHJcbiAgY29uc29sZS5sb2coJ0dlbmVyYXRpbmcgdHJlbmRzIGZyb20gcG9wdWxhciBrZXl3b3JkcycpO1xyXG4gIFxyXG4gIGNvbnN0IHBvcHVsYXJLZXl3b3Jkc0J5VG9waWM6IFJlY29yZDxzdHJpbmcsIHN0cmluZ1tdPiA9IHtcclxuICAgIGludmVzdGluZzogWydFVEYnLCAnc3RvY2tzJywgJ3BvcnRmb2xpbycsICdkaXZpZGVuZHMnLCAnY3J5cHRvJywgJ3JldGlyZW1lbnQnLCAnc2F2aW5ncycsICdtYXJrZXQnXSxcclxuICAgIGVkdWNhdGlvbjogWydzdHVkeScsICdsZWFybmluZycsICdza2lsbHMnLCAnY291cnNlcycsICd0dXRvcmlhbCcsICd0aXBzJywgJ3Byb2R1Y3Rpdml0eScsICdzdWNjZXNzJ10sXHJcbiAgICB0b3VyaXNtOiBbJ3RyYXZlbCcsICdkZXN0aW5hdGlvbnMnLCAndmFjYXRpb24nLCAnYWR2ZW50dXJlJywgJ2N1bHR1cmUnLCAnZm9vZCcsICdidWRnZXQnLCAnZ3VpZGUnXSxcclxuICAgIHRlY2hub2xvZ3k6IFsnQUknLCAnc29mdHdhcmUnLCAnZ2FkZ2V0cycsICdpbm5vdmF0aW9uJywgJ2NvZGluZycsICdhcHBzJywgJ2Z1dHVyZScsICd0cmVuZHMnXSxcclxuICAgIGhlYWx0aDogWydmaXRuZXNzJywgJ251dHJpdGlvbicsICd3ZWxsbmVzcycsICdleGVyY2lzZScsICdkaWV0JywgJ21lbnRhbCcsICdsaWZlc3R5bGUnLCAndGlwcyddLFxyXG4gICAgZmluYW5jZTogWydtb25leScsICdidWRnZXQnLCAnc2F2aW5ncycsICdkZWJ0JywgJ2NyZWRpdCcsICdsb2FucycsICdwbGFubmluZycsICd3ZWFsdGgnXVxyXG4gIH07XHJcbiAgXHJcbiAgY29uc3QgcmVzdWx0cyA9IFtdO1xyXG4gIFxyXG4gIGZvciAoY29uc3QgdG9waWMgb2YgdG9waWNzKSB7XHJcbiAgICBjb25zdCBrZXl3b3JkcyA9IHBvcHVsYXJLZXl3b3Jkc0J5VG9waWNbdG9waWMudG9Mb3dlckNhc2UoKV0gfHwgWyd0aXBzJywgJ2d1aWRlJywgJ3R1dG9yaWFsJywgJ2Jlc3QnXTtcclxuICAgIGNvbnN0IHRyZW5kcyA9IFtdO1xyXG4gICAgXHJcbiAgICAvLyBHZW5lcmF0ZSBzeW50aGV0aWMgdHJlbmRzIGJhc2VkIG9uIHBvcHVsYXIga2V5d29yZHNcclxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgTWF0aC5taW4oNSwga2V5d29yZHMubGVuZ3RoKTsgaSsrKSB7XHJcbiAgICAgIGNvbnN0IGtleXdvcmQgPSBrZXl3b3Jkc1tpXTtcclxuICAgICAgY29uc3QgdHJlbmQgPSB7XHJcbiAgICAgICAgdG9waWMsXHJcbiAgICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksXHJcbiAgICAgICAgdmlkZW9JZDogYGZhbGxiYWNrXyR7dG9waWN9XyR7a2V5d29yZH1fJHtEYXRlLm5vdygpfV8ke2l9YCxcclxuICAgICAgICB0aXRsZTogYCR7a2V5d29yZH0gJHt0b3BpY30gR3VpZGU6IEVzc2VudGlhbCBUaXBzIGZvciBCZWdpbm5lcnNgLFxyXG4gICAgICAgIHZpZXdDb3VudDogTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogNTAwMDApICsgMTAwMDAsXHJcbiAgICAgICAgbGlrZUNvdW50OiBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiAyMDAwKSArIDUwMCxcclxuICAgICAgICBjb21tZW50Q291bnQ6IE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIDMwMCkgKyA1MCxcclxuICAgICAgICBlbmdhZ2VtZW50UmF0ZTogTWF0aC5yYW5kb20oKSAqIDMgKyAyLCAvLyAyLTUlXHJcbiAgICAgICAgZW5nYWdlbWVudFNjb3JlOiBNYXRoLnJhbmRvbSgpICogMC4wMyArIDAuMDIsIC8vIDAuMDItMC4wNVxyXG4gICAgICAgIGtleXdvcmRzOiBba2V5d29yZCwgdG9waWMsICdndWlkZScsICd0aXBzJywgJ3R1dG9yaWFsJ10sXHJcbiAgICAgICAgY2F0ZWdvcnlJZDogJzI3JyxcclxuICAgICAgICBwdWJsaXNoZWRBdDogbmV3IERhdGUoRGF0ZS5ub3coKSAtIE1hdGgucmFuZG9tKCkgKiAyNCAqIDYwICogNjAgKiAxMDAwKS50b0lTT1N0cmluZygpLFxyXG4gICAgICAgIGNoYW5uZWxUaXRsZTogYCR7dG9waWN9IEV4cGVydGAsXHJcbiAgICAgICAgY2hhbm5lbElkOiBgZmFsbGJhY2tfY2hhbm5lbF8ke3RvcGljfWAsXHJcbiAgICAgICAgZGVzY3JpcHRpb246IGBMZWFybiBhYm91dCAke2tleXdvcmR9IGluICR7dG9waWN9IHdpdGggdGhpcyBjb21wcmVoZW5zaXZlIGd1aWRlYFxyXG4gICAgICB9O1xyXG4gICAgICBcclxuICAgICAgdHJlbmRzLnB1c2godHJlbmQpO1xyXG4gICAgfVxyXG4gICAgXHJcbiAgICBjb25zdCB0b3BUcmVuZCA9IHRyZW5kc1swXTtcclxuICAgIGNvbnN0IGF2ZXJhZ2VFbmdhZ2VtZW50ID0gdHJlbmRzLnJlZHVjZSgoc3VtLCB0cmVuZCkgPT4gc3VtICsgdHJlbmQuZW5nYWdlbWVudFNjb3JlLCAwKSAvIHRyZW5kcy5sZW5ndGg7XHJcbiAgICBcclxuICAgIHJlc3VsdHMucHVzaCh7XHJcbiAgICAgIHRvcGljLFxyXG4gICAgICB0cmVuZHMsXHJcbiAgICAgIHRvcFRyZW5kLFxyXG4gICAgICB0cmVuZHNGb3VuZDogdHJlbmRzLmxlbmd0aCxcclxuICAgICAgYXZlcmFnZUVuZ2FnZW1lbnQsXHJcbiAgICAgIHNvdXJjZTogJ0ZBTExCQUNLX0tFWVdPUkRTJ1xyXG4gICAgfSk7XHJcbiAgICBcclxuICAgIGNvbnNvbGUubG9nKGBHZW5lcmF0ZWQgJHt0cmVuZHMubGVuZ3RofSBmYWxsYmFjayB0cmVuZHMgZm9yIHRvcGljOiAke3RvcGljfWApO1xyXG4gIH1cclxuICBcclxuICByZXR1cm4gcmVzdWx0cztcclxufVxyXG5cclxuYXN5bmMgZnVuY3Rpb24gZ2VuZXJhdGVGcm9tVGVtcGxhdGVzKHRvcGljczogc3RyaW5nW10pOiBQcm9taXNlPGFueVtdPiB7XHJcbiAgY29uc29sZS5sb2coJ0dlbmVyYXRpbmcgdHJlbmRzIGZyb20gdGVtcGxhdGVzJyk7XHJcbiAgXHJcbiAgY29uc3QgdGVtcGxhdGVzID0gW1xyXG4gICAgJ1VsdGltYXRlIHt0b3BpY30gR3VpZGUgZm9yIEJlZ2lubmVycycsXHJcbiAgICAnVG9wIDEwIHt0b3BpY30gVGlwcyBFdmVyeW9uZSBTaG91bGQgS25vdycsXHJcbiAgICAne3RvcGljfSBNaXN0YWtlcyB0byBBdm9pZCBpbiAyMDI0JyxcclxuICAgICdDb21wbGV0ZSB7dG9waWN9IFR1dG9yaWFsOiBTdGVwIGJ5IFN0ZXAnLFxyXG4gICAgJ0Jlc3Qge3RvcGljfSBTdHJhdGVnaWVzIFRoYXQgQWN0dWFsbHkgV29yaydcclxuICBdO1xyXG4gIFxyXG4gIGNvbnN0IHJlc3VsdHMgPSBbXTtcclxuICBcclxuICBmb3IgKGNvbnN0IHRvcGljIG9mIHRvcGljcykge1xyXG4gICAgY29uc3QgdHJlbmRzID0gW107XHJcbiAgICBcclxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGVtcGxhdGVzLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgIGNvbnN0IHRlbXBsYXRlID0gdGVtcGxhdGVzW2ldO1xyXG4gICAgICBjb25zdCB0aXRsZSA9IHRlbXBsYXRlLnJlcGxhY2UoJ3t0b3BpY30nLCB0b3BpYy5jaGFyQXQoMCkudG9VcHBlckNhc2UoKSArIHRvcGljLnNsaWNlKDEpKTtcclxuICAgICAgXHJcbiAgICAgIGNvbnN0IHRyZW5kID0ge1xyXG4gICAgICAgIHRvcGljLFxyXG4gICAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLFxyXG4gICAgICAgIHZpZGVvSWQ6IGB0ZW1wbGF0ZV8ke3RvcGljfV8ke0RhdGUubm93KCl9XyR7aX1gLFxyXG4gICAgICAgIHRpdGxlLFxyXG4gICAgICAgIHZpZXdDb3VudDogTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogMzAwMDApICsgNTAwMCxcclxuICAgICAgICBsaWtlQ291bnQ6IE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIDE1MDApICsgMzAwLFxyXG4gICAgICAgIGNvbW1lbnRDb3VudDogTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogMjAwKSArIDMwLFxyXG4gICAgICAgIGVuZ2FnZW1lbnRSYXRlOiBNYXRoLnJhbmRvbSgpICogMi41ICsgMS41LCAvLyAxLjUtNCVcclxuICAgICAgICBlbmdhZ2VtZW50U2NvcmU6IE1hdGgucmFuZG9tKCkgKiAwLjAyNSArIDAuMDE1LCAvLyAwLjAxNS0wLjA0XHJcbiAgICAgICAga2V5d29yZHM6IFt0b3BpYywgJ2d1aWRlJywgJ3RpcHMnLCAndHV0b3JpYWwnLCAnYmVnaW5uZXJzJ10sXHJcbiAgICAgICAgY2F0ZWdvcnlJZDogJzI3JyxcclxuICAgICAgICBwdWJsaXNoZWRBdDogbmV3IERhdGUoRGF0ZS5ub3coKSAtIE1hdGgucmFuZG9tKCkgKiAxMiAqIDYwICogNjAgKiAxMDAwKS50b0lTT1N0cmluZygpLFxyXG4gICAgICAgIGNoYW5uZWxUaXRsZTogYCR7dG9waWN9IEFjYWRlbXlgLFxyXG4gICAgICAgIGNoYW5uZWxJZDogYHRlbXBsYXRlX2NoYW5uZWxfJHt0b3BpY31gLFxyXG4gICAgICAgIGRlc2NyaXB0aW9uOiBgQ29tcHJlaGVuc2l2ZSAke3RvcGljfSBjb250ZW50IGZvciBsZWFybmVycyBvZiBhbGwgbGV2ZWxzYFxyXG4gICAgICB9O1xyXG4gICAgICBcclxuICAgICAgdHJlbmRzLnB1c2godHJlbmQpO1xyXG4gICAgfVxyXG4gICAgXHJcbiAgICBjb25zdCB0b3BUcmVuZCA9IHRyZW5kc1swXTtcclxuICAgIGNvbnN0IGF2ZXJhZ2VFbmdhZ2VtZW50ID0gdHJlbmRzLnJlZHVjZSgoc3VtLCB0cmVuZCkgPT4gc3VtICsgdHJlbmQuZW5nYWdlbWVudFNjb3JlLCAwKSAvIHRyZW5kcy5sZW5ndGg7XHJcbiAgICBcclxuICAgIHJlc3VsdHMucHVzaCh7XHJcbiAgICAgIHRvcGljLFxyXG4gICAgICB0cmVuZHMsXHJcbiAgICAgIHRvcFRyZW5kLFxyXG4gICAgICB0cmVuZHNGb3VuZDogdHJlbmRzLmxlbmd0aCxcclxuICAgICAgYXZlcmFnZUVuZ2FnZW1lbnQsXHJcbiAgICAgIHNvdXJjZTogJ1RFTVBMQVRFJ1xyXG4gICAgfSk7XHJcbiAgICBcclxuICAgIGNvbnNvbGUubG9nKGBHZW5lcmF0ZWQgJHt0cmVuZHMubGVuZ3RofSB0ZW1wbGF0ZS1iYXNlZCB0cmVuZHMgZm9yIHRvcGljOiAke3RvcGljfWApO1xyXG4gIH1cclxuICBcclxuICByZXR1cm4gcmVzdWx0cztcclxufVxyXG5cclxuZnVuY3Rpb24gY3JlYXRlRmFsbGJhY2tUcmVuZCh0b3BpYzogc3RyaW5nKTogYW55IHtcclxuICByZXR1cm4ge1xyXG4gICAgdG9waWMsXHJcbiAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSxcclxuICAgIHZpZGVvSWQ6IGBmYWxsYmFja18ke3RvcGljfV8ke0RhdGUubm93KCl9YCxcclxuICAgIHRpdGxlOiBgRXNzZW50aWFsICR7dG9waWMuY2hhckF0KDApLnRvVXBwZXJDYXNlKCkgKyB0b3BpYy5zbGljZSgxKX0gR3VpZGVgLFxyXG4gICAgdmlld0NvdW50OiAxNTAwMCxcclxuICAgIGxpa2VDb3VudDogNzUwLFxyXG4gICAgY29tbWVudENvdW50OiAxMDAsXHJcbiAgICBlbmdhZ2VtZW50UmF0ZTogNS42NyxcclxuICAgIGVuZ2FnZW1lbnRTY29yZTogMC4wNTcsXHJcbiAgICBrZXl3b3JkczogW3RvcGljLCAnZ3VpZGUnLCAnZXNzZW50aWFsJywgJ3RpcHMnXSxcclxuICAgIGNhdGVnb3J5SWQ6ICcyNycsXHJcbiAgICBwdWJsaXNoZWRBdDogbmV3IERhdGUoRGF0ZS5ub3coKSAtIDYgKiA2MCAqIDYwICogMTAwMCkudG9JU09TdHJpbmcoKSxcclxuICAgIGNoYW5uZWxUaXRsZTogYCR7dG9waWN9IEJhc2ljc2AsXHJcbiAgICBjaGFubmVsSWQ6IGBmYWxsYmFja18ke3RvcGljfWAsXHJcbiAgICBkZXNjcmlwdGlvbjogYEJhc2ljICR7dG9waWN9IGluZm9ybWF0aW9uIGFuZCBndWlkYW5jZWBcclxuICB9O1xyXG59Il19